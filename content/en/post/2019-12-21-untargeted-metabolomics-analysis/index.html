---
title: metflow2 and metID workflow
author: Xiaotao Shen
date: '2019-12-21'
slug: ''
categories:
  - R
tags:
  - Blog
  - Chinese
image:
  caption: ''
  focal_point: ''
output:
  blogdown::html_page:
    toc: true
    number_sections: true
---


<div id="TOC">
<ul>
<li><a href="#instalation"><span class="toc-section-number">1</span> Instalation</a></li>
<li><a href="#raw-data-processing"><span class="toc-section-number">2</span> Raw data processing</a></li>
<li><a href="#data-cleaning"><span class="toc-section-number">3</span> Data cleaning</a><ul>
<li><a href="#positive-mode"><span class="toc-section-number">3.1</span> Positive mode</a></li>
<li><a href="#negative-mode"><span class="toc-section-number">3.2</span> Negative mode</a></li>
</ul></li>
<li><a href="#metabolite-identification"><span class="toc-section-number">4</span> Metabolite identification</a></li>
</ul>
</div>

<div id="instalation" class="section level1">
<h1><span class="header-section-number">1</span> Instalation</h1>
<pre class="r"><code>if(!require(devtools)){
  install.packages(&quot;devtools&quot;)
}

if(!require(tidyverse)){
  install.packages(&quot;tidyverse&quot;)
}
devtools::install_github(&quot;jaspershen/metflow2&quot;)
devtools::install_github(&quot;jaspershen/metID&quot;)
devtools::install_github(&quot;jaspershen/tinyTools&quot;)
devtools::install_github(&quot;jaspershen/sxtTools&quot;)

library(metflow2)
library(metID)
library(tidyverse)</code></pre>
<p>Use <code>Chicago</code> data as a example.</p>
<p>This data is in workstation. The work directory is in <code>D:/shenxt/project/depression142</code>. And the data organization is like this:</p>
<p><img src="figure1.png" /></p>
</div>
<div id="raw-data-processing" class="section level1">
<h1><span class="header-section-number">2</span> Raw data processing</h1>
<p>All the mzXML data should be placed in a folder names as <code>XCMS_processing</code>. Like this figure shows:</p>
<p><img src="figure2.png" /></p>
<pre class="r"><code>setwd(&quot;D:/shenxt/project/depression142/RPLC/POS/XCMS_Processing&quot;)
metflow2::processData(polarity = &#39;positive&#39;,
                      peakwidth = c(5, 30), 
                      threads = 10, 
                      min.fraction = 0.8, 
                      fill.peaks = FALSE,
                      output.tic = TRUE, 
                      output.bpc = TRUE,
                      output.rt.correction.plot = TRUE)</code></pre>
<p><strong>Note</strong>:</p>
<ul>
<li><p>polarity: <code>positive</code> or <code>negative</code>.</p></li>
<li><p>peakwidth: for RPLC, set it as <code>c(5, 30)</code>, for HILIC, set it as <code>c(10, 60)</code>.</p></li>
</ul>
<p>All the results will be outputed in a folder named as <code>Result</code>.</p>
<p><img src="figure3.png" /></p>
<p><code>Peak.table.csv</code> is the Peak.table from XCMS.</p>
<p><code>RT correction plot</code></p>
<p><img src="RT%20correction%20plot.png" /></p>
</div>
<div id="data-cleaning" class="section level1">
<h1><span class="header-section-number">3</span> Data cleaning</h1>
<p>First, please copy the <code>Peak.table.csv</code> from XCMS to another folder, I recommed data cleaning in your own PC or Mac.</p>
<p>And you also need a <code>sample_info.csv</code> to provide the information of each sample..</p>
<p><img src="figure4.png" /></p>
<div id="positive-mode" class="section level2">
<h2><span class="header-section-number">3.1</span> Positive mode</h2>
<pre class="r"><code>setwd(&quot;xxx/data_cleaning/RPLC/POS&quot;)
peak_table &lt;- readr::read_csv(&quot;Peak.table.csv&quot;)

peak_table &lt;- 
  peak_table %&gt;% 
  rename(name = sample.name,
         mz = mzmed,
         rt = rtmed) %&gt;% 
  select(-c(peak.name, mzmin, mzmax, rtmin, rtmax, npeaks, Blank, QC, Subject, QC_DL))

readr::write_csv(peak_table, &quot;peak_table.csv&quot;)

####creat object
(
  rplc_pos_1 &lt;-
    creatMetflowObject(
      ms1.data = &quot;peak_table.csv&quot;,
      sample.information = &quot;sample_info.csv&quot;,
      path = &quot;.&quot;
    )
)

save(rplc_pos_1, file = &quot;rplc_pos_1&quot;)

###remove peaks
(
  rplc_pos_2 &lt;-
    filterPeak(
      object = rplc_pos_1,
      min.fraction.qc = 0.8,##QC at least more than 80%
      min.fraction = 0.2,##Subject no restraction
      min.subject.qc.ratio = 0,##don&#39;t use blank to remove any peaks
      dl.qc.r2.cutoff = 0
    )
)


save(rplc_pos_2, file = &quot;rplc_pos_2&quot;)

###remove some samples (outliers)
(
  rplc_pos_3 &lt;-
    filterSample(object = rplc_pos_2,
                 min.fraction.peak = 0.5)
)

save(rplc_pos_3, file = &quot;rplc_pos_3&quot;)


#get the MV distribution plot
(
  plot &lt;- 
    getMVplot4sample(object = rplc_pos_3)
)


#MV imputateion

(
  rplc_pos_4 &lt;- 
    imputeMV(object = rplc_pos_3, method = &#39;knn&#39;)
)

save(rplc_pos_4, file = &quot;rplc_pos_4&quot;)

###RSD distribution
qc_rsd &lt;- calRSD(object = rplc_pos_4, slot = &quot;QC&quot;)

(plot1 &lt;- 
    ggplot(data = qc_rsd, aes(index, rsd)) +
    geom_hline(yintercept = 30, linetype = 2, colour = &quot;red&quot;) +
    geom_point() +
    scale_y_continuous(name = &quot;Relative standard deviation (RSD, %)&quot;, limits = c(0,100),
                       breaks = c(0, 25, 30, 50, 75, 100), labels = c(c(0, 25, 30, 50, 75, 100)))+
    labs(x = &quot;Peak index&quot;) +
    theme_bw() +
    theme(axis.title = element_text(size = 15),
          axis.text = element_text(size = 12),
          legend.title = element_text(size = 15),
          legend.text = element_text(size = 12),
          strip.background = element_rect(fill = &quot;#0099B47F&quot;),
          strip.text = element_text(color = &quot;white&quot;, size = 15))
)


(plot2 &lt;- 
    ggplot(data = qc_rsd, aes(x = rsd)) +
    geom_histogram(binwidth = 10, colour = &quot;white&quot;, fill = &quot;#0099B47F&quot;, origin = 0) +
    scale_x_continuous(name = &quot;Relative standard deviation (RSD, %)&quot;) +
    labs(y = &quot;Peak number&quot;) +
    # geom_vline(xintercept = 30, linetype = 2, colour = &quot;red&quot;) +
    annotate(geom = &quot;rect&quot;, xmin = 0, xmax = 30, ymin = 0, ymax = 380,
             alpha = 0.1, fill = &quot;#ED00007F&quot;) +
    theme_bw()+
    theme(axis.title = element_text(size = 15),
          axis.text = element_text(size = 12),
          legend.title = element_text(size = 15),
          legend.text = element_text(size = 12),
          strip.background = element_rect(fill = &quot;#0099B47F&quot;),
          strip.text = element_text(color = &quot;white&quot;, size = 15))
)




## data normalization
(
  rplc_pos_5 &lt;- 
    normalizeData(object = rplc_pos_4, 
                  method = &quot;mean&quot;)
)

save(rplc_pos_5, file = &quot;rplc_pos_5&quot;)

###batch intergration

(
  rplc_pos_6 &lt;- 
    metflow2:::integrateData(
      object = rplc_pos_5, 
      method = &quot;subject.mean&quot;)
)

save(rplc_pos_6, file = &quot;rplc_pos_6&quot;)

##output peak table after data cleaning
peak_table_after_cleaning &lt;- rplc_pos_6@ms1.data[[1]]
readr::write_csv(peak_table_after_cleaning, &quot;peak_table_after_cleaning.csv&quot;)</code></pre>
<p><code>peak_table_after_cleaning.csv</code> is the peak table after data cleaning.</p>
</div>
<div id="negative-mode" class="section level2">
<h2><span class="header-section-number">3.2</span> Negative mode</h2>
<pre class="r"><code>sxtTools::setwd_project()
####Negative mode
setwd(&quot;data_cleaning/RPLC/NEG&quot;)
peak_table &lt;- readr::read_csv(&quot;Peak.table.csv&quot;)


peak_table &lt;- 
  peak_table %&gt;% 
  rename(name = sample.name,
         mz = mzmed,
         rt = rtmed) %&gt;% 
  select(-c(peak.name, mzmin, mzmax, rtmin, rtmax, npeaks, Blank, QC, Subject, QC_DL))


readr::write_csv(peak_table, &quot;peak_table.csv&quot;)

####creat object

(
  rplc_neg_1 &lt;-
    creatMetflowObject(
      ms1.data = &quot;peak_table.csv&quot;,
      sample.information = &quot;sample_info.csv&quot;,
      path = &quot;.&quot;
    )
)

save(rplc_neg_1, file = &quot;rplc_neg_1&quot;)

###remove peaks
(
  rplc_neg_2 &lt;-
    filterPeak(
      object = rplc_neg_1,
      min.fraction.qc = 0.8,##QC at least more than 80%
      min.fraction = 0.2,##Subject no restraction
      min.subject.qc.ratio = 0,##don&#39;t use blank to remove any peaks
      dl.qc.r2.cutoff = 0
    )
)


save(rplc_neg_2, file = &quot;rplc_neg_2&quot;)

###remove some samples (outliers)
(
  rplc_neg_3 &lt;-
    filterSample(object = rplc_neg_2,
                 min.fraction.peak = 0.5)
)

save(rplc_neg_3, file = &quot;rplc_neg_3&quot;)


#get the MV distribution plot
(
  plot &lt;- 
    getMVplot4sample(object = rplc_neg_3)
)


#MV imputateion

(
  rplc_neg_4 &lt;- 
    imputeMV(object = rplc_neg_3, method = &#39;knn&#39;)
)

save(rplc_neg_4, file = &quot;rplc_neg_4&quot;)

###RSD distribution
qc_rsd &lt;- calRSD(object = rplc_neg_4, slot = &quot;QC&quot;)

(plot1 &lt;- 
    ggplot(data = qc_rsd, aes(index, rsd)) +
    geom_hline(yintercept = 30, linetype = 2, colour = &quot;red&quot;) +
    geom_point() +
    scale_y_continuous(name = &quot;Relative standard deviation (RSD, %)&quot;, limits = c(0,100),
                       breaks = c(0, 25, 30, 50, 75, 100), labels = c(c(0, 25, 30, 50, 75, 100)))+
    labs(x = &quot;Peak index&quot;) +
    theme_bw() +
    theme(axis.title = element_text(size = 15),
          axis.text = element_text(size = 12),
          legend.title = element_text(size = 15),
          legend.text = element_text(size = 12),
          strip.background = element_rect(fill = &quot;#0099B47F&quot;),
          strip.text = element_text(color = &quot;white&quot;, size = 15))
)


(plot2 &lt;- 
    ggplot(data = qc_rsd, aes(x = rsd)) +
    geom_histogram(binwidth = 10, colour = &quot;white&quot;, fill = &quot;#0099B47F&quot;, origin = 0) +
    scale_x_continuous(name = &quot;Relative standard deviation (RSD, %)&quot;) +
    labs(y = &quot;Peak number&quot;) +
    # geom_vline(xintercept = 30, linetype = 2, colour = &quot;red&quot;) +
    annotate(geom = &quot;rect&quot;, xmin = 0, xmax = 30, ymin = 0, ymax = 380,
             alpha = 0.1, fill = &quot;#ED00007F&quot;) +
    theme_bw()+
    theme(axis.title = element_text(size = 15),
          axis.text = element_text(size = 12),
          legend.title = element_text(size = 15),
          legend.text = element_text(size = 12),
          strip.background = element_rect(fill = &quot;#0099B47F&quot;),
          strip.text = element_text(color = &quot;white&quot;, size = 15))
)




## data normalization
(
  rplc_neg_5 &lt;- 
    normalizeData(object = rplc_neg_4, 
                  method = &quot;mean&quot;)
)

save(rplc_neg_5, file = &quot;rplc_neg_5&quot;)

###batch intergration

(
  rplc_neg_6 &lt;- 
    metflow2:::integrateData(
      object = rplc_neg_5, 
      method = &quot;subject.mean&quot;)
)

save(rplc_neg_6, file = &quot;rplc_neg_6&quot;)

##output peak table after data cleaning
peak_table_after_cleaning &lt;- rplc_neg_6@ms1.data[[1]]
readr::write_csv(peak_table_after_cleaning, &quot;peak_table_after_cleaning.csv&quot;)</code></pre>
</div>
</div>
<div id="metabolite-identification" class="section level1">
<h1><span class="header-section-number">4</span> Metabolite identification</h1>
<p>Please copy the peak table after data cleaning to the folder in workstaiton:</p>
<p><code>D:\shenxt\project\smartD\RPLC\POS\metabolite_annotation\NCE25</code> and <code>D:\shenxt\project\smartD\RPLC\POS\metabolite_annotation\NCE50</code>.</p>
<p>And then copy all the MS2 library to <code>D:\shenxt\project\smartD\RPLC\POS\metabolite_annotation\NCE25</code> and <code>D:\shenxt\project\smartD\RPLC\POS\metabolite_annotation\NCE50</code>. The MS2 library can be found here:</p>
<p><code>D:\shenxt\project\database\metabolite</code>.</p>
<pre class="r"><code>#####RPLC positive
setwd(&quot;D:/shenxt/project/smartD/RPLC/POS/metabolite_annotation/NCE25&quot;)
library(metID)
parameter1 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25, 
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;positive&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;msDatabase_rplc0.0.1&quot;, 
                               threads = 4)

parameter2 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25,
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;positive&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;hmdbDatabase0.0.1&quot;, 
                               threads = 4)

parameter3 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25, 
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;positive&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;massbankDatabase0.0.1&quot;, 
                               threads = 4)

parameter4 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25, 
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;positive&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;metlinDatabase0.0.1&quot;, 
                               threads = 4)

parameter5 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25, 
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;positive&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;monaDatabase0.0.1&quot;, 
                               threads = 4)

parameter6 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25, 
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;positive&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;nistDatabase0.0.1&quot;, 
                               threads = 4)

parameter7 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25, 
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;positive&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;orbitrapDatabase0.0.1&quot;, 
                               threads = 4)

parameter8 &lt;- mzIdentifyParam(ms1.match.ppm = 25, 
                              polarity = &quot;positive&quot;, 
                              column = &quot;rp&quot;, 
                              candidate.num = 3,
                              database = &quot;HMDB.metabolite.data&quot;, 
                              threads = 4)

ms1.data &lt;- grep(&quot;\\.csv&quot;, dir(), value = TRUE)
ms2.data &lt;- grep(&quot;mgf&quot;, dir(), value = TRUE)

result.pRPLC.nce25 &lt;- metIdentify4all(
  ms1.data = ms1.data,
  ms2.data = ms2.data,
  parameter.list = c(
    parameter1,
    parameter2,
    parameter3,
    parameter4,
    parameter5,
    parameter6,
    parameter7,
    parameter8
  ),
  path = &quot;.&quot;
)

save(result.pRPLC.nce25, file = &quot;result.pRPLC.nce25&quot;)

setwd(&quot;../NCE50&quot;)
ms1.data &lt;- grep(&quot;\\.csv&quot;, dir(), value = TRUE)
ms2.data &lt;- grep(&quot;mgf&quot;, dir(), value = TRUE)
result.pRPLC.nce50 &lt;- metIdentify4all(ms1.data = ms1.data,
                                      ms2.data = ms2.data, 
                                      parameter.list = c(parameter1,
                                                         parameter2,
                                                         parameter3,
                                                         parameter4,
                                                         parameter5,
                                                         parameter6,
                                                         parameter7),
                                      path = &quot;.&quot;)

save(result.pRPLC.nce50, file = &quot;result.pRPLC.nce50&quot;)

#####RPLC negative
setwd(&quot;D:/shenxt/project/smartD/RPLC/NEG/metabolite_annotation/NCE25&quot;)
parameter1 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25, 
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;negative&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;msDatabase_rplc0.0.1&quot;, 
                               threads = 4)

parameter2 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25,
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;negative&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;hmdbDatabase0.0.1&quot;, 
                               threads = 4)

parameter3 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25, 
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;negative&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;massbankDatabase0.0.1&quot;, 
                               threads = 4)

parameter4 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25, 
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;negative&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;metlinDatabase0.0.1&quot;, 
                               threads = 4)

parameter5 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25, 
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;negative&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;monaDatabase0.0.1&quot;, 
                               threads = 4)

parameter6 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25, 
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;negative&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;nistDatabase0.0.1&quot;, 
                               threads = 4)

parameter7 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25, 
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;negative&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;orbitrapDatabase0.0.1&quot;, 
                               threads = 4)

parameter8 &lt;- mzIdentifyParam(ms1.match.ppm = 25, 
                              polarity = &quot;negative&quot;, 
                              column = &quot;rp&quot;, 
                              candidate.num = 3,
                              database = &quot;HMDB.metabolite.data&quot;, 
                              threads = 4)


ms1.data &lt;- grep(&quot;\\.csv&quot;, dir(), value = TRUE)
ms2.data &lt;- grep(&quot;mgf&quot;, dir(), value = TRUE)
result.nRPLC.nce25 &lt;- metIdentify4all(ms1.data = ms1.data,
                                      ms2.data = ms2.data, 
                                      parameter.list = c(parameter1,
                                                         parameter2,
                                                         parameter3,
                                                         parameter4,
                                                         parameter5,
                                                         parameter6,
                                                         parameter7,
                                                         parameter8),
                                      path = &quot;.&quot;)

save(result.nRPLC.nce25, 
     file = &quot;result.nRPLC.nce25&quot;)

setwd(&quot;../NCE50&quot;)

ms1.data &lt;- grep(&quot;\\.csv&quot;, dir(), value = TRUE)
ms2.data &lt;- grep(&quot;mgf&quot;, dir(), value = TRUE)
result.nRPLC.nce50 &lt;- metIdentify4all(ms1.data = ms1.data,
                                      ms2.data = ms2.data, 
                                      parameter.list = c(parameter1,
                                                         parameter2,
                                                         parameter3,
                                                         parameter4,
                                                         parameter5,
                                                         parameter6,
                                                         parameter7),
                                      path = &quot;.&quot;)

save(result.nRPLC.nce50, file = &quot;result.nRPLC.nce50&quot;)

###get annotation table
####RPLC positive
setwd(&quot;D:/shenxt/project/smartD/RPLC/POS/metabolite_annotation&quot;)
load(&quot;NCE25/result.pRPLC.nce25&quot;)
load(&quot;NCE50/result.pRPLC.nce50&quot;)

identification.table1 &lt;- getIdentificationTable(result.pRPLC.nce25[[1]],
                                                result.pRPLC.nce50[[1]],
                                                candidate.num = 1,
                                                type = &quot;old&quot;)
identification.table1 &lt;-
  identification.table1 %&gt;%
  filter(!is.na(Identification)) %&gt;%
  mutate(Level = 1)


identification.table2 &lt;-
  getIdentificationTable(
    result.pRPLC.nce25[[2]],
    result.pRPLC.nce25[[3]],
    result.pRPLC.nce25[[4]],
    result.pRPLC.nce25[[5]],
    result.pRPLC.nce25[[6]],
    result.pRPLC.nce25[[7]],
    result.pRPLC.nce50[[2]],
    result.pRPLC.nce50[[3]],
    result.pRPLC.nce50[[4]],
    result.pRPLC.nce50[[5]],
    result.pRPLC.nce50[[6]],
    result.pRPLC.nce50[[7]],
    candidate.num = 1,
    type = &quot;old&quot;
  )

identification.table2 &lt;-
  identification.table2 %&gt;% 
  filter(!is.na(Identification), !is.element(name, identification.table1$name)) %&gt;% 
  mutate(Level = 2)

identification.table3 &lt;- 
  getIdentificationTable2(result.pRPLC.nce25[[8]],
                          candidate.num = 3,
                          type = &quot;old&quot;)

identification.table3 &lt;-
  identification.table3 %&gt;% 
  filter(!is.na(Identification), !is.element(name, identification.table1$name), !is.element(name, identification.table2$name)) %&gt;% 
  mutate(Level = 3)

identification.table &lt;- 
  dplyr::full_join(rbind(identification.table1, identification.table2), 
                   identification.table3, 
                   by = colnames(identification.table3))

write.csv(identification.table, &quot;identification.table.csv&quot;, row.names = FALSE)


identification.table.new &lt;- trans2newStyle(identification.table = identification.table)
write.csv(identification.table.new, &quot;identification.table.new.csv&quot;, row.names = FALSE)


####RPLC negative
setwd(&quot;D:/shenxt/project/smartD/RPLC/NEG/metabolite_annotation&quot;)
load(&quot;NCE25/result.nRPLC.nce25&quot;)
load(&quot;NCE50/result.nRPLC.nce50&quot;)

identification.table1 &lt;- getIdentificationTable(result.nRPLC.nce25[[1]],
                                                result.nRPLC.nce50[[1]],
                                                candidate.num = 1,
                                                type = &quot;old&quot;)

identification.table1 &lt;- 
  identification.table1 %&gt;% 
  filter(!is.na(Identification)) %&gt;% 
  mutate(Level = 1)

identification.table2 &lt;-
  getIdentificationTable(
    result.nRPLC.nce25[[2]],
    result.nRPLC.nce25[[3]],
    result.nRPLC.nce25[[4]],
    result.nRPLC.nce25[[5]],
    result.nRPLC.nce25[[6]],
    result.nRPLC.nce25[[7]],
    result.nRPLC.nce50[[2]],
    result.nRPLC.nce50[[3]],
    result.nRPLC.nce50[[4]],
    result.nRPLC.nce50[[5]],
    result.nRPLC.nce50[[6]],
    result.nRPLC.nce50[[7]],
    candidate.num = 1,
    type = &quot;old&quot;
  )

identification.table2 &lt;-
  identification.table2 %&gt;% 
  filter(!is.na(Identification), !is.element(name, identification.table1$name)) %&gt;% 
  mutate(Level = 2)


identification.table3 &lt;- 
  getIdentificationTable2(result.nRPLC.nce25[[8]],
                          candidate.num = 3,
                          type = &quot;old&quot;)


identification.table3 &lt;-
  identification.table3 %&gt;% 
  filter(!is.na(Identification), !is.element(name, identification.table1$name), !is.element(name, identification.table2$name)) %&gt;% 
  mutate(Level = 3)

identification.table &lt;- 
  dplyr::full_join(rbind(identification.table1, identification.table2), 
                   identification.table3, 
                   by = colnames(identification.table3))

write.csv(identification.table, &quot;identification.table.csv&quot;, row.names = FALSE)


identification.table.new &lt;- trans2newStyle(identification.table = identification.table)
write.csv(identification.table.new, &quot;identification.table.new.csv&quot;, row.names = FALSE)</code></pre>
<p>For HILIC data, the identification is same, just change <code>parameter1</code> as :</p>
<pre><code>parameter1 &lt;- metIdentifyParam(ms1.ms2.match.mz.tol = 25, 
                               ms1.ms2.match.rt.tol = 60, 
                               ms1.match.ppm = 25, 
                               ms2.match.tol = 0.4, 
                               rt.match.tol = 90,
                               polarity = &quot;negative&quot;, 
                               ce = &quot;all&quot;, 
                               column = &quot;rp&quot;, 
                               total.score.tol = 0, 
                               candidate.num = 3,
                               database = &quot;msDatabase_hilic0.0.1&quot;, 
                               threads = 4)</code></pre>
<p>And change the result name as <code>result.pHILIC.nce25</code>,<code>result.pHILIC.nce50</code>,<code>result.nHILIC.nce25</code> and <code>result.nHILIC.nce50</code>.</p>
</div>
