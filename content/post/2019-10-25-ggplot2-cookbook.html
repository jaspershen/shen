---
title: ggplot2-cookbook
author: Xiaotao Shen
date: '2019-10-25'
slug: ggplot2-cookbook
categories:
  - R
tags:
  - Blog
image:
  caption: ''
  focal_point: ''
---



<div id="绘图基础plot-basics" class="section level2">
<h2>绘图基础(plot basics)</h2>
<p>所有的ggplot2图形都开始于<code>ggplot()</code>函数的调用.给其提供数据,以及美学映射(aesthethic mappings)(使用<code>aes()</code>函数).然后添加图层(layers), 度量系统(scales), 坐标系(coords)以及分面(facets).添加的每个对象,都是在前一行末尾使用符号<code>+</code>.如果需要将一个ggplot2图像保存在本地,使用<code>ggsave()</code>函数.</p>
<div id="ggplot-创建一个新的ggplot图片" class="section level3">
<h3><code>ggplot()</code> 创建一个新的ggplot图片</h3>
<p><code>ggplot()</code>函数是用来启动初始化一个ggplot2对象的.It can be used to declare the input data frame for a graphic and to specify the set of plot aesthetics intended to be common throughout all subsequent layers unless specifically overridden.</p>
<pre><code>ggplot(data = NULL, mapping = aes(), ...,
  environment = parent.frame())
Arguments</code></pre>
<div id="参数" class="section level4">
<h4>参数</h4>
<ul>
<li><p><strong>data</strong> 用于绘图的数据.如果数据格式不是<code>data.frame</code>,会默认使用<code>fortity()</code>函数转换为<code>data.frame</code>格式.如果在该函数中不提供data,则在后面添加的每一个图层,都需要提供data.</p></li>
<li><p><strong>mapping</strong> 用于美学图层映射的参数.如果在这里不提供,则后面添加的每个图层,都需要提供.</p></li>
<li><p><strong>…</strong> 其他可用于该函数的参数.</p></li>
<li><p><strong>environment</strong> 该参数已经淘汰了.</p></li>
</ul>
</div>
<div id="细节" class="section level4">
<h4>细节</h4>
<p><code>ggplot()</code>用来初始化ggplot2图形对象.经常后面需要通过<code>+</code>来添加其他的对象.一般有三种方法调用该函数:</p>
<ul>
<li><p><code>ggplot(df, aes(x, y, other aesthetics))</code></p></li>
<li><p><code>ggplot(df)</code></p></li>
<li><p><code>ggplot2</code></p></li>
</ul>
<p>如果后面的所有图层使用的都是同一套数据以及美学映射,则推荐使用第一种用法.如果后面图层使用数据一致,但是美学映射不同,则推荐使用第二种方法.如果每一个图层使用的数据和美学映射都不相同,则使用第三种方法,一般用来构建比较复杂的图形.</p>
</div>
<div id="例子" class="section level4">
<h4>例子</h4>
<pre class="r"><code>library(ggplot2)</code></pre>
<pre><code>## Warning: package &#39;ggplot2&#39; was built under R version 3.6.1</code></pre>
<pre class="r"><code># 产生随机数据,然后计算平均值和标准差
df &lt;- data.frame(
  gp = factor(rep(letters[1:3], each = 10)),
  y = rnorm(30)
)
ds &lt;- do.call(rbind, lapply(split(df, df$gp), function(d) {
  data.frame(mean = mean(d$y), sd = sd(d$y), gp = d$gp)
}))

ggplot(df, aes(gp, y)) +
  geom_point() +
  geom_point(data = ds, aes(y = mean), colour = &#39;red&#39;, size = 3)</code></pre>
<p><img src="/post/2019-10-25-ggplot2-cookbook_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<pre class="r"><code>#注意,第一个geom_point图层使用的是ggplot中的数据和美学映射.而第二个geom_point
#图层中使用的则是不同的数据和美学映射.

# 而下面这幅图,第一个geonm_point图层因为没有提供data,因此使用的是ggplot()中的data,
#而美学映射则是自己定义的.

ggplot(df) +
  geom_point(aes(gp, y)) +
  geom_point(data = ds, aes(gp, mean), colour = &#39;red&#39;, size = 3)</code></pre>
<p><img src="/post/2019-10-25-ggplot2-cookbook_files/figure-html/unnamed-chunk-1-2.png" width="672" /></p>
<pre class="r"><code># 另外一个选择则是完全不在ggplot中定义数据和美学映射,而是在每一个图层中分别定义.
# 当你要画复杂图形的时候,这种方法就会显示的非常清晰和明了.
ggplot() +
  geom_point(data = df, aes(gp, y)) +
  geom_point(data = ds, aes(gp, mean), colour = &#39;red&#39;, size = 3) +
  geom_errorbar(
    data = ds,
    aes(gp, mean, ymin = mean - sd, ymax = mean + sd),
    colour = &#39;red&#39;,
    width = 0.4
  )</code></pre>
<pre><code>## Warning: Ignoring unknown aesthetics: y</code></pre>
<p><img src="/post/2019-10-25-ggplot2-cookbook_files/figure-html/unnamed-chunk-1-3.png" width="672" /></p>
</div>
</div>
<div id="aes-创建美学映射" class="section level3">
<h3><code>aes()</code> 创建美学映射</h3>
<p>美学映射指的是数据中的变量如何映射到图形的视觉特性上(也就是美学aesthetics).美学映射可以在<code>ggplot()</code>函数以及每一个单独的图层中进行设置.</p>
<p><code>aes(x, y, ...)</code></p>
<div id="参数-1" class="section level4">
<h4>参数</h4>
<ul>
<li><strong>x, y, …</strong> 将变量映射到图形的视觉特性的名字.x和y分别指x轴和y轴.通常他们可以省略不写.但是其他的,如颜色(colour/color),填充颜色(fill),大小(size)等则必须写明参数名字.</li>
</ul>
</div>
<div id="细节-1" class="section level4">
<h4>细节</h4>
<p>注意的是,在ggplot2种,对于视觉特征的名字进行了规范化,因此和R base绘图函数种的并不相同,比如从<code>pch</code>改为<code>shape</code>,从<code>cex</code>改为<code>size</code>.</p>
</div>
<div id="例子-1" class="section level4">
<h4>例子</h4>
<pre class="r"><code>aes(x = mpg, y = wt)</code></pre>
<pre><code>## Aesthetic mapping: 
## * `x` -&gt; `mpg`
## * `y` -&gt; `wt`</code></pre>
<pre class="r"><code>#&gt; Aesthetic mapping: 
#&gt; * `x` -&gt; `mpg`
#&gt; * `y` -&gt; `wt`
aes(mpg, wt)</code></pre>
<pre><code>## Aesthetic mapping: 
## * `x` -&gt; `mpg`
## * `y` -&gt; `wt`</code></pre>
<pre class="r"><code>#&gt; Aesthetic mapping: 
#&gt; * `x` -&gt; `mpg`
#&gt; * `y` -&gt; `wt`

# You can also map aesthetics to functions of variables
aes(x = mpg ^ 2, y = wt / cyl)</code></pre>
<pre><code>## Aesthetic mapping: 
## * `x` -&gt; `mpg^2`
## * `y` -&gt; `wt/cyl`</code></pre>
<pre class="r"><code>#&gt; Aesthetic mapping: 
#&gt; * `x` -&gt; `mpg^2`
#&gt; * `y` -&gt; `wt/cyl`

# Or to constants
aes(x = 1, colour = &quot;smooth&quot;)</code></pre>
<pre><code>## Aesthetic mapping: 
## * `x`      -&gt; 1
## * `colour` -&gt; &quot;smooth&quot;</code></pre>
<pre class="r"><code>#&gt; Aesthetic mapping: 
#&gt; * `x`      -&gt; 1
#&gt; * `colour` -&gt; &quot;smooth&quot;

# Aesthetic names are automatically standardised
aes(col = x)</code></pre>
<pre><code>## Aesthetic mapping: 
## * `colour` -&gt; `x`</code></pre>
<pre class="r"><code>#&gt; Aesthetic mapping: 
#&gt; * `colour` -&gt; `x`
aes(fg = x)</code></pre>
<pre><code>## Aesthetic mapping: 
## * `colour` -&gt; `x`</code></pre>
<pre class="r"><code>#&gt; Aesthetic mapping: 
#&gt; * `colour` -&gt; `x`
aes(color = x)</code></pre>
<pre><code>## Aesthetic mapping: 
## * `colour` -&gt; `x`</code></pre>
<pre class="r"><code>#&gt; Aesthetic mapping: 
#&gt; * `colour` -&gt; `x`
aes(colour = x)</code></pre>
<pre><code>## Aesthetic mapping: 
## * `colour` -&gt; `x`</code></pre>
<pre class="r"><code>#&gt; Aesthetic mapping: 
#&gt; * `colour` -&gt; `x`

# aes() is passed to either ggplot() or specific layer. Aesthetics supplied
# to ggplot() are used as defaults for every layer.
ggplot(mpg, aes(displ, hwy)) + geom_point()</code></pre>
<p><img src="/post/2019-10-25-ggplot2-cookbook_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<pre class="r"><code>ggplot(mpg) + geom_point(aes(displ, hwy))</code></pre>
<p><img src="/post/2019-10-25-ggplot2-cookbook_files/figure-html/unnamed-chunk-2-2.png" width="672" /></p>
<pre class="r"><code># Tidy evaluation ----------------------------------------------------
# aes() automatically quotes all its arguments, so you need to use tidy
# evaluation to create wrappers around ggplot2 pipelines. The
# simplest case occurs when your wrapper takes dots:
scatter_by &lt;- function(data, ...) {
  ggplot(data) + geom_point(aes(...))
}
scatter_by(mtcars, disp, drat)</code></pre>
<p><img src="/post/2019-10-25-ggplot2-cookbook_files/figure-html/unnamed-chunk-2-3.png" width="672" /></p>
<pre class="r"><code># If your wrapper has a more specific interface with named arguments,
# you need &quot;enquote and unquote&quot;:
scatter_by &lt;- function(data, x, y) {
  x &lt;- enquo(x)
  y &lt;- enquo(y)

  ggplot(data) + geom_point(aes(!!x, !!y))
}
scatter_by(mtcars, disp, drat)</code></pre>
<p><img src="/post/2019-10-25-ggplot2-cookbook_files/figure-html/unnamed-chunk-2-4.png" width="672" /></p>
<pre class="r"><code># Note that users of your wrapper can use their own functions in the
# quoted expressions and all will resolve as it should!
cut3 &lt;- function(x) cut_number(x, 3)
scatter_by(mtcars, cut3(disp), drat)</code></pre>
<p><img src="/post/2019-10-25-ggplot2-cookbook_files/figure-html/unnamed-chunk-2-5.png" width="672" /></p>
</div>
</div>
</div>
